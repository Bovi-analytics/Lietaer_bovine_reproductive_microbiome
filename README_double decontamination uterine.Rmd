# Low microbial biomass within the reproductive tract of late postpartum dairy cows: a study approach"

This is a notebook for the microbiome analysis data of Lietaer et al. (2020). 

When you execute code within the notebook, the results appear beneath the code. 

# Statistical analysis preface

Currently the following R packages were loaded

```{r, echo=FALSE}
#Import csv
if (!require("readr")) {
  install.packages("readr", dependencies = TRUE)
  library(readr)
}

#General purpose toolbox
if (!require("psych")) {
  install.packages("psych", dependencies = TRUE)
  library(psych)
}

#Dunn's Test - multiple comparisons using rank sums
if (!require("dunn.test")) {
  install.packages("dunn.test", dependencies = TRUE)
  library(dunn.test)
}

#Visualisations
if (!require("ggplot2")) {
  install.packages("ggplot2", dependencies = TRUE)
  library(ggplot2)
}

#Customizing 'ggplot2'- based publication ready plots
if (!require("ggpubr")) {
  install.packages("ggpubr", dependencies = TRUE)
  library(ggpubr)
}

#BiocManager
if (!requireNamespace("BiocManager", quietly = TRUE)) {
  install.packages("BiocManager")
  library(BiocManager)
}

#Phyloseq - microbiome data analysis
if (!require("phyloseq")) {
  source("https://raw.githubusercontent.com/joey711/phyloseq/master/inst/scripts/installer.R", local = TRUE)
  install_phyloseq(branch = "github")
  library(phyloseq); packageVersion("phyloseq")
}

#Decontam - filtering contaminant sequences - Davis et.al. 2018
if (!require("decontam")) {
  install.packages("decontam", dependencies = TRUE)
  library(decontam); packageVersion("decontam")
}

#tidyverse - data manipulation
if (!require("tidyverse")) {
  install.packages("tidyverse", dependencies = TRUE)
  library(tidyverse)
}

#vegan - community ecology package
if (!require("vegan")) {
  install.packages("vegan", dependencies = TRUE)
  library(vegan)
}

#microbiome - tools for microbiome analysis
if (!require("microbiome")) {
  install.packages("microbiome", dependencies = TRUE)
  library(microbiome)
}

#limma - venn diagrams
if (!require("limma")) {
  install.packages("limma", dependencies = TRUE)
  library(limma)
}

#write excel
if (!require("writexl")) {
  install.packages("writexl", dependencies = TRUE)
  library(writexl)
}

#color panel
if (!require("viridis")) {
  install.packages("viridis", dependencies = TRUE)
  library(viridis)
}

#graphics layout
if (!require("grid")) {
  install.packages("grid", dependencies = TRUE)
  library(grid)
}

#graphics layout plot_grid
if (!require("cowplot")) {
  install.packages("cowplot", dependencies = TRUE)
  library(cowplot)
}
```

# Data extraction, transformation and loading

The data was read from the csv file

```{r}
metadata <- read_delim("./metadata.csv", 
    ";", escape_double = FALSE, trim_ws = TRUE)
metadata <- data.frame(metadata)
metadata$merge_factor <- metadata$Location

# Change metadata column names
metadata$Location <- plyr::revalue(metadata$Location, replace = 
                                     c("RT" = "Right Tip",
                                       "RB" = "Right Base",
                                       "LT" = "Left Tip",
                                       "LB" = "Left Base",
                                       "VAG" = "Vagina",
                                       "CTR" = "Sampling Control", 
                                       "BLANK" = "Extraction Blank"))
metadata$Location <- factor(as.character(metadata$Location), 
                            levels = c("RT" = "Right Tip",
                                       "RB" = "Right Base",
                                       "LT" = "Left Tip",
                                       "LB" = "Left Base",
                                       "VAG" = "Vagina",
                                       "CTR" = "Sampling Control", 
                                       "BLANK" = "Extraction Blank"))

metadata$Sample_or_Control <- factor(as.character(metadata$Sample_or_Control))
metadata$UT_or_VAG <- factor(as.character(metadata$UT_or_VAG))


otu_data <- read_delim("./otu_table_Lietaer.csv", 
    ";", escape_double = FALSE, trim_ws = TRUE)
```

# Microbial community analyses: taxonomic identification original dataset

## Original dataset - OTU level - all samples and controls 

### Create Phyloseq object "physeq" from csv file - original - all samples and controls

```{r}
# Taxonomy table
tax_df <-otu_data %>% dplyr::select(OTU:genus)
rownames(tax_df) <- tax_df$OTU

# Create OTU table with all samples and controls
otu_df <- otu_data %>% dplyr::select(RT1:VAG5)

# Name the rows with the names of the OTUs
rownames(otu_df) <- tax_df$OTU

tax_df <- tax_df %>% dplyr::select(-c(OTU,Size))

physeq <- phyloseq(otu_table(otu_df, taxa_are_rows = TRUE),
                   tax_table(as.matrix(tax_df)))

colnames(tax_table(physeq)) <- c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus")
rownames(metadata) <- metadata$Sample # make sure rownames are matching with physeq
sample_data(physeq) <- sample_data(metadata) # add metadata

summarize_phyloseq(physeq)
```

### check rarefaction curves and library size

```{r}
# check rarefaction curves
otu_tab <- t(abundances(physeq))
p <- vegan::rarecurve(otu_tab, step = 50, label = TRUE, sample = min (rowSums(otu_tab), Col = "red", cex = 0.5))

# Check library sizes
hist(sample_sums(physeq), breaks = 100)
print(sample_sums(physeq))
```
```{r}
# number of OTUs per sample
numberotu_df <- otu_table(physeq)
colSums(numberotu_df != 0)
```

### Visualisation

HEX colors - all samples and controls - family level

```{r}
###Select 25 top otus based on relative abunance
#Relative abundance
relabsphyseq <- transform_sample_counts(physeq , function(x) x/sum(x))
# Select 25 top otus based on relative abunance
TopNOTUs.relab <- names(sort(taxa_sums(relabsphyseq), TRUE)[1:25])
physeqobj25.relab  <- prune_taxa(TopNOTUs.relab, relabsphyseq)

#family level barplot
phyplot.rel.family <- plot_bar(physeqobj25.relab, x ="Sample", fill="Family")
phyplot.rel.family + 
  facet_grid(~ Location, scales="free_x", space = "free_x") +
  ylab("Relative Abundance")+ xlab("")+
  scale_fill_manual(values= c("#FFFF00", "#FFEC00", "#FFD308", "#EDFB3C", "#BAD303", "#4F820D", "#385C0A", "#0F8482", "#418CFC", "#92D8FE", "#334C89", "#61307D", "#AD208E", "#FC43D3", "#F8642C", "#D63118", "#9F2A00", "#7C5547"))+
  theme_bw()+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20),
        title=element_text(size=20), legend.text=element_text(size=16),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 12))
```

## Original dataset - OTU level - only DNA extraction blank controls

### Create Phyloseq object "physeqblank" from csv file - original - only DNA extraction blank controls

```{r}
# Taxonomy table
blanktax_df <-otu_data %>% dplyr::select(OTU:genus)
rownames(blanktax_df) <- blanktax_df$OTU

# Create OTU table with only DNA extraction blank controls
otu_df <- otu_data %>% dplyr::select(RT1:VAG5) # all samples and controls
blank_df <- otu_df %>% dplyr::select(BLANK1, BLANK2, BLANK3) # only blank controls

# Name the rows with the names of the OTUs
rownames(blank_df) <- blanktax_df$OTU

blanktax_df <- blanktax_df %>% dplyr::select(-c(OTU,Size))

# Create Phyloseq object "physeqblank" - only DNA extraction blank controls
physeqblank <- phyloseq(otu_table(blank_df, taxa_are_rows = TRUE),
                   tax_table(as.matrix(blanktax_df)))

colnames(tax_table(physeqblank)) <- c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus")
rownames(metadata) <- metadata$Sample # make sure rownames are matching with physeq
sample_data(physeqblank) <- sample_data(metadata) # add metadata

summarize_phyloseq(physeqblank)
```

### Visualisation

viridis colors - only DNA extraction blank controls - genus level and family level

```{r}
### Select 25 top otus based on relative abunance
# Relative abundance
relabsphyseqblank <- transform_sample_counts(physeqblank , function(x) x/sum(x))
# Select 25 top otus based on relative abunance
TopNOTUs.relablank <- names(sort(taxa_sums(relabsphyseqblank), TRUE)[1:25])
physeqobj25.relablank  <- prune_taxa(TopNOTUs.relablank, relabsphyseqblank)

# Genus level barplot
phyplot.relblank.genus <- plot_bar(physeqobj25.relablank, x ="Sample", fill="Genus")
phyplot.relblank.genus + 
  facet_grid(~ Location, scales="free_x", space = "free_x") +
  ylab("Relative Abundance (%)")+ xlab("")+
  scale_fill_viridis(discrete=TRUE, option="plasma")+
  theme_bw()+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20),
        title=element_text(size=20), legend.text=element_text(size=16),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 12))

# family level barplot
phyplot.relblank.family <- plot_bar(physeqobj25.relablank, x ="Sample", fill="Family")
phyplot.relblank.family + 
  facet_grid(~ Location, scales="free_x", space = "free_x") +
  ylab("Relative Abundance (%)")+ xlab("")+
  scale_fill_viridis(discrete=TRUE, option="plasma")+
  theme_bw()+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20),
        title=element_text(size=20), legend.text=element_text(size=16),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 12))
```

## Original dataset - OTU level - only vaginal samples

### Create Phyloseq object "physeqvag" from csv file - original - only vaginal samples

```{r}
# Create phyloseq object from csv file
# Taxonomy table
tax_df <-otu_data %>% dplyr::select(OTU:genus)
rownames(tax_df) <- tax_df$OTU

# Create OTU table with all samples
otu_df <- otu_data %>% dplyr::select(RT1:VAG5)
vagina_df <- otu_df %>% dplyr::select(VAG1, VAG2, VAG3, VAG4, VAG5)

# Name the rows with the names of the OTUs
rownames(vagina_df) <- tax_df$OTU

tax_df <- tax_df %>% dplyr::select(-c(OTU,Size))

physeqvag <- phyloseq(otu_table(vagina_df, taxa_are_rows = TRUE),
                   tax_table(as.matrix(tax_df)))

colnames(tax_table(physeqvag)) <- c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus")
rownames(metadata) <- metadata$Sample # make sure rownames are matching with physeq
sample_data(physeqvag) <- sample_data(metadata) # add metadata

summarize_phyloseq(physeqvag)
```

### Visualisation

only vaginal samples - genus level (viridis colors) and family level (HEX colors)

```{r}
### Select 25 top otus based on relative abunance
# Relative abundance
relabsphyseqvag <- transform_sample_counts(physeqvag , function(x) x/sum(x))

# Select 25 top otus based on relative abunance
TopNOTUs.relabvag <- names(sort(taxa_sums(relabsphyseqvag), TRUE)[1:25])
physeqobj25.relabvag  <- prune_taxa(TopNOTUs.relabvag, relabsphyseqvag)

# Genus level barplot
phyplot.relvag.genus <- plot_bar(physeqobj25.relabvag, x ="Sample", fill="Genus")
phyplot.relvag.genus + 
  facet_grid(~ Location, scales="free_x", space = "free_x") +
  ylab("Relative Abundance (%)")+ xlab("")+
  scale_fill_viridis(discrete=TRUE, option="plasma")+
  theme_bw()+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20),
        title=element_text(size=20), legend.text=element_text(size=16),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 12))

# family level barplot
phyplot.relvag.family <- plot_bar(physeqobj25.relabvag, x ="Sample", fill="Family")
phyplot.relvag.family + 
  facet_grid(~ Location, scales="free_x", space = "free_x") +
  scale_y_continuous(breaks=seq(0,1,0.25), limits=c(0,1))+
  ylab("Relative Abundance")+ xlab("")+
  scale_fill_manual(values= c("#CCCCCC", "#CCCC99", "#CC9900", "#CCFFCC", "#71C0A7", "#66FFCC", "#BAD303", "#006666", "#CCFFFF", "#999999", "#385C0A", "#0F8482", "#92D8FE", "#9999CC", "#CC0099", "#FC43D3", "#9F2A00"))+
  theme_bw()+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20),
        title=element_text(size=20), legend.text=element_text(size=16),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 12))
```

## Original dataset -  OTU level - only uterine samples

### Create Phyloseq object "physequt" from csv file - original - only uterine samples

```{r}
# metadata
metadata_uterus <- metadata[c(1:4, 9:12, 15:18, 22:25, 27:30),]

# Create phyloseq object from csv file
# Taxonomy table
tax_df <-otu_data %>% dplyr::select(OTU:genus)
rownames(tax_df) <- tax_df$OTU

# Create OTU table "uterus_df" with only uterine samples
otu_df <- otu_data %>% dplyr::select(RT1:VAG5)
uterus_df <- otu_df %>% dplyr::select(RT1,RT2,RT3,RT4,RT5,RB1,RB2,RB3,RB4,RB5,LT1,LT2,LT3,LT4,LT5,LB1,LB2,LB3,LB4,LB5)

# Name the rows with the names of the OTUs
rownames(uterus_df) <- tax_df$OTU

tax_df <- tax_df %>% dplyr::select(-c(OTU,Size))

physequterus <- phyloseq(otu_table(uterus_df, taxa_are_rows = TRUE),
                   tax_table(as.matrix(tax_df)))

colnames(tax_table(physequterus)) <- c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus")
rownames(metadata) <- metadata$Sample # make sure rownames are matching with physeq
sample_data(physequterus) <- sample_data(metadata) # add metadata

summarize_phyloseq(physequterus)
```

```{r}
# otu table "physequterus" as matrix / data.frame
# Extract abundance matrix from the phyloseq object
otu_uterus = as(otu_table(physequterus), "matrix")
# transpose if necessary
if(taxa_are_rows(physequterus)){otu_uterus <- t(otu_uterus)}
# Coerce to data.frame
OTUdf_uterus = as.data.frame(otu_uterus)
```

### Visualisation

viridis colors - only uterine samples - genus level (viridis colors) and family level (HEX colors)

```{r}
### Select 25 top otus based on relative abundance
#Relative abundance
relabphysequterus <- transform_sample_counts(physequterus , function(x) x/sum(x))
### Select 25 top otus based on relative abunance
TopNOTUs.relabuterus <- names(sort(taxa_sums(relabphysequterus), TRUE)[1:25])
physeqobj25.relabuterus  <- prune_taxa(TopNOTUs.relabuterus, relabphysequterus)

# genus level barplot
phyplot.relut.genus <- plot_bar(physeqobj25.relabuterus, x ="Sample", fill="Genus")
phyplot.relut.genus + 
  facet_grid(~ Location, scales="free_x", space = "free_x") +
  ylab("Relative Abundance (%)")+ xlab("")+
  scale_fill_viridis(discrete=TRUE, option="plasma")+
  theme_bw()+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20),
        title=element_text(size=20), legend.text=element_text(size=16),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 12))

# family level barplot
phyplot.relut.family <- plot_bar(physeqobj25.relabuterus, x ="Sample", fill="Family")
phyplot.relut.family + 
  facet_grid(~ Location, scales="free_x", space = "free_x") +
  ylab("Relative Abundance (%)")+ xlab("")+
  scale_fill_manual(values= c("#FFFF00", "#FFEC00", "#FFFFFF", "#FFD308", "#EDFB3C", "#BAD303", "#4F820D", "#166D66", "#418CFC", "#92D8FE", "#334C89", "#61307D", "#AD208E", "#F8642C", "#D63118", "#9F2A00", "#7C5547", "#440000"))+
  theme_bw()+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20),
        title=element_text(size=20), legend.text=element_text(size=16),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 12))
  
```

## Original dataset - pooled by Phylum level - all samples and controls 

### Create Phyloseq object "physeq_phylum_scale" - original - pooled by phylum level - all samples and controls

```{r}
# start from Phyloseq object physeq -> Pool at phylum level to make physeq_scale
physeq_phylum_scale = tax_glom(physeq, "Phylum")

# Calculate relative abundances
relabphyseq_phylum_scale <- transform_sample_counts(physeq_phylum_scale, function(x) 100*x/sum(x))

# Select top 5 phyla, and all others combined in "other"
TopNPhyla.relabphyseq_phylum_scale <- names(sort(taxa_sums(relabphyseq_phylum_scale), TRUE)[1:5])
tax_table(relabphyseq_phylum_scale)[!taxa_names(relabphyseq_phylum_scale) %in% TopNPhyla.relabphyseq_phylum_scale, "Phylum"] <- "Other"

# psmelt into dataframe
df_relabphyseq_phylum_scale_pruned <- psmelt(relabphyseq_phylum_scale)

sum_table_phyla <- df_relabphyseq_phylum_scale_pruned %>% group_by(Phylum) %>% summarize(sum_abund = sum(Abundance))

# sort phyla in order of abundance, put "other" last
names_sorted_phyla <- as.character(sum_table_phyla$Phylum)[order(sum_table_phyla$sum_abund, decreasing = TRUE)]
names_sorted_phyla <- c(names_sorted_phyla[names_sorted_phyla != "Other"],
                         names_sorted_phyla[names_sorted_phyla == "Other"])

df_relabphyseq_phylum_scale_pruned$Phylum <- factor(as.character(df_relabphyseq_phylum_scale_pruned$Phylum),
                                       levels = names_sorted_phyla)

# Finally we merge the Phyla present in "Others"
df_relabphyseq_phylum_scale_pruned_remerged <- df_relabphyseq_phylum_scale_pruned %>% 
  group_by(Phylum, Sample) %>% summarize(sum_abund = sum(Abundance))

# Add metadata AGAIN
df_relabphyseq_phylum_scale_pruned_remerged <- left_join(df_relabphyseq_phylum_scale_pruned_remerged,
                                             metadata[-6], 
                                                by = c("Sample" = "Sample")
                                             ) %>% distinct()
```

### Visualisation

all samples and controls - phylum level

```{r}
# Generate a plot with the relative abundances pooled by phylum - facet by Location
phyplot.phylum <- ggplot(aes(Sample, y = sum_abund, 
                        fill = Phylum, color = Phylum), data = df_relabphyseq_phylum_scale_pruned_remerged)+
  geom_bar(stat="identity", alpha = 1)+
  scale_color_manual(values = rep("black", 26))+
  facet_grid(~ Location, scales="free_x", space = "free_x") +
  ylab("Relative Abundance (%)")+ xlab("")+
  scale_fill_manual(values= c("#D40C00", "#FF9A00", "#EDFB3C", "#87C735", "#526EFF", "#4B0082"))+
  theme_bw()+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20),
        title=element_text(size=20), legend.text=element_text(size=16),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 12))

print(phyplot.phylum)
```

### Create Phyloseq object "physeq_family_scale" - original - pooled by family level - all samples and controls

```{r}
# Pool at family level
physeq_family_scale = tax_glom(physeq, "Family")

# Calculate relative abundances
relabphyseq_family_scale <- transform_sample_counts(physeq_family_scale, function(x) 100*x/sum(x))

# Select top 5 families
TopNFamilies.relabphyseq_family_scale <- names(sort(taxa_sums(relabphyseq_family_scale), TRUE)[1:5])
tax_table(relabphyseq_family_scale)[!taxa_names(relabphyseq_family_scale) %in% TopNFamilies.relabphyseq_family_scale, "Family"] <- "Other"

# psmelt into dataframe
df_relabphyseq_family_scale_pruned <- psmelt(relabphyseq_family_scale)

sum_table_families <- df_relabphyseq_family_scale_pruned %>% group_by(Family) %>% summarize(sum_abund = sum(Abundance))

# sort families in order of abundance, put "other" last
names_sorted_families <- as.character(sum_table_families$Family)[order(sum_table_families$sum_abund,
                                                                  decreasing = TRUE)]
names_sorted_families <- c(names_sorted_families[names_sorted_families != "Other"],
                         names_sorted_families[names_sorted_families == "Other"])

df_relabphyseq_family_scale_pruned$Family <- factor(as.character(df_relabphyseq_family_scale_pruned$Family),
                                       levels = names_sorted_families)

# Finally we merge the Genera present in "Others"
df_relabphyseq_family_scale_pruned_remerged <- df_relabphyseq_family_scale_pruned %>% 
  group_by(Family, Sample) %>% summarize(sum_abund = sum(Abundance))

# Add metadata AGAIN
df_relabphyseq_family_scale_pruned_remerged <- left_join(df_relabphyseq_family_scale_pruned_remerged,
                                             metadata[-6], 
                                                by = c("Sample" = "Sample")
                                             ) %>% distinct()
```

### Visualisation

all samples and controls - family level

```{r}
# Generate a plot with the relative abundances pooled by family - facet by Location
phyplot.family <- ggplot(aes(Sample, y = sum_abund, 
                        fill = Family, color = Family), data = df_relabphyseq_family_scale_pruned_remerged)+
  geom_bar(stat="identity", alpha = 1)+
  scale_color_manual(values = rep("black", 26))+
  facet_grid(~ Location, scales="free_x", space = "free_x") +
  ylab("Relative Abundance (%)")+ xlab("")+
  scale_fill_manual(values= c("#D40C00", "#FF9A00", "#EDFB3C", "#87C735", "#526EFF", "#4B0082"))+
  theme_bw()+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20),
        title=element_text(size=20), legend.text=element_text(size=16),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 12))

print(phyplot.family)
```

## Original dataset - pooled by Family level - only vaginal samples 

### Create Phyloseq object "physeqvag_family_scale" - original - pooled by family level - only vaginal samples

```{r}
# Pool at family level
physeqvag_family_scale = tax_glom(physeqvag, "Family")

# Calculate relative abundances
relabphyseqvag_family_scale <- transform_sample_counts(physeqvag_family_scale, function(x) 100*x/sum(x))

# Select top 5 families
TopNFamilies.relabphyseqvag_family_scale <- names(sort(taxa_sums(relabphyseqvag_family_scale), TRUE)[1:5])
tax_table(relabphyseqvag_family_scale)[!taxa_names(relabphyseqvag_family_scale) %in% TopNFamilies.relabphyseqvag_family_scale, "Family"] <- "Other"

# psmelt into dataframe
df_relabphyseqvag_family_scale_pruned <- psmelt(relabphyseqvag_family_scale)

sum_table_families <- df_relabphyseqvag_family_scale_pruned %>% group_by(Family) %>% summarize(sum_abund = sum(Abundance))

# sort families in order of abundance, put "other" last
names_sorted_families <- as.character(sum_table_families$Family)[order(sum_table_families$sum_abund,
                                                                  decreasing = TRUE)]
names_sorted_families <- c(names_sorted_families[names_sorted_families != "Other"],
                         names_sorted_families[names_sorted_families == "Other"])

df_relabphyseqvag_family_scale_pruned$Family <- factor(as.character(df_relabphyseqvag_family_scale_pruned$Family),
                                       levels = names_sorted_families)

# Finally we merge the families present in "Others"
df_relabphyseqvag_family_scale_pruned_remerged <- df_relabphyseqvag_family_scale_pruned %>% 
  group_by(Family, Sample) %>% summarize(sum_abund = sum(Abundance))

# Add metadata AGAIN
df_relabphyseqvag_family_scale_pruned_remerged <- left_join(df_relabphyseqvag_family_scale_pruned_remerged,
                                             metadata[-6], 
                                                by = c("Sample" = "Sample")
                                             ) %>% distinct()
```

### Visualisation

only vaginal samples - family level

```{r}
# Generate a plot with the relative abundances pooled by family - facet by Location
phyplot.family.vag <- ggplot(aes(Sample, y = sum_abund, 
                        fill = Family, color = Family), data = df_relabphyseqvag_family_scale_pruned_remerged)+
  geom_bar(stat="identity", alpha = 1)+
  scale_color_manual(values = rep("black", 26))+
  facet_grid(~ Location, scales="free_x", space = "free_x") +
  ylab("Relative Abundance (%)")+ xlab("")+
  scale_fill_manual(values= c("#D40C00", "#FF9A00", "#EDFB3C", "#87C735", "#526EFF", "#4B0082"))+
  theme_bw()+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20),
        title=element_text(size=20), legend.text=element_text(size=16),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 12))

print(phyplot.family.vag)
```

## Original dataset - pooled by Family level - only uterine samples 

### Create Phyloseq object "physequterus_family_scale" - original - pooled by family level - only uterine samples

```{r}
# Pool at family level
physequterus_family_scale = tax_glom(physequterus, "Family")

# Calculate relative abundances
relabphysequterus_family_scale <- transform_sample_counts(physequterus_family_scale, function(x) 100*x/sum(x))

# Select top 5 families
TopNFamilies.relabphysequterus_family_scale <- names(sort(taxa_sums(relabphysequterus_family_scale), TRUE)[1:5])
tax_table(relabphysequterus_family_scale)[!taxa_names(relabphysequterus_family_scale) %in% TopNFamilies.relabphysequterus_family_scale, "Family"] <- "Other"

# psmelt into dataframe
df_relabphysequterus_family_scale_pruned <- psmelt(relabphysequterus_family_scale)

sum_table_families <- df_relabphysequterus_family_scale_pruned %>% group_by(Family) %>% summarize(sum_abund = sum(Abundance))

# sort families in order of abundance, put "other" last
names_sorted_families <- as.character(sum_table_families$Family)[order(sum_table_families$sum_abund,
                                                                  decreasing = TRUE)]
names_sorted_families <- c(names_sorted_families[names_sorted_families != "Other"],
                         names_sorted_families[names_sorted_families == "Other"])

df_relabphysequterus_family_scale_pruned$Family <- factor(as.character(df_relabphysequterus_family_scale_pruned$Family),
                                       levels = names_sorted_families)

# Finally we merge the families present in "Others"
df_relabphysequterus_family_scale_pruned_remerged <- df_relabphysequterus_family_scale_pruned %>% 
  group_by(Family, Sample) %>% summarize(sum_abund = sum(Abundance))

# Add metadata AGAIN
df_relabphysequterus_family_scale_pruned_remerged <- left_join(df_relabphysequterus_family_scale_pruned_remerged,
                                             metadata[-6], 
                                                by = c("Sample" = "Sample")
                                             ) %>% distinct()
```

### Visualisation

only uterine samples - family level

```{r}
# Generate a plot with the relative abundances pooled by family - facet by Location
phyplot.family.uterus <- ggplot(aes(Sample, y = sum_abund, 
                        fill = Family, color = Family), data = df_relabphysequterus_family_scale_pruned_remerged)+
  geom_bar(stat="identity", alpha = 1)+
  scale_color_manual(values = rep("black", 26))+
  facet_grid(~ Location, scales="free_x", space = "free_x") +
  ylab("Relative Abundance (%)")+ xlab("")+
  scale_fill_manual(values= c("#D40C00", "#FF9A00", "#EDFB3C", "#87C735", "#526EFF", "#4B0082"))+
  theme_bw()+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20),
        title=element_text(size=20), legend.text=element_text(size=16),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 12))

print(phyplot.family.uterus)
```

# Microbial community analyses: alpha and beta diversities

## Alpha diversity

### Original dataset - uterine samples

```{r}
alpha_uterus <- estimate_richness(physequterus, measures = c("Shannon", "InvSimpson"))
alpha_uterus

hist(alpha_uterus$Shannon, main="Shannon diversity", xlab="", breaks=10)
hist(alpha_uterus$InvSimpson, main="Inverse Simpson diversity", xlab="", breaks=10)

shapiro.test(alpha_uterus$Shannon)
shapiro.test(alpha_uterus$InvSimpson)

kruskallocation_alpha_uterus <- t(sapply(alpha_uterus, function(x) unlist(kruskal.test(x~sample_data(physequterus)$Location)[c("estimate","p.value","statistic","conf.int")])))
kruskallocation_alpha_uterus

dunn.test(alpha_uterus$Shannon, sample_data(physequterus)$Location, method="bonferroni")
dunn.test(alpha_uterus$InvSimpson, sample_data(physequterus)$Location, method="bonferroni")

location <- c(rep(c("RT","RB","LT","LB"), each = 5))
animal <- c("1", "2", "3", "4", "5", "1", "2", "3", "4", "5", "1", "2", "3", "4", "5", "1", "2", "3", "4", "5")
alpha_uterus <- cbind(alpha_uterus, location, animal)
alpha_uterus

friedmanlocation_shannon_uterus <- friedman.test(alpha_uterus$Shannon, alpha_uterus$location, alpha_uterus$animal)
friedmanlocation_shannon_uterus

friedmanlocation_InvSimpson_uterus <- friedman.test(alpha_uterus$InvSimpson, alpha_uterus$location, alpha_uterus$animal)
friedmanlocation_InvSimpson_uterus
```

#### Visualisation

Plot alpha diversity original dataset, uterine samples

```{r}
plot_alpha_uterus <- plot_richness(physequterus, x="Location", measures=c("Shannon", "InvSimpson"), color="Location")
plot_alpha_uterus +  theme_bw() +
  scale_color_manual(values= c("#952EA0","#DF488D", "#F89078", "#e8fa5bff"))+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20),
        title=element_text(size=14), legend.text=element_text(size=14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 12))
```

Plot alpha diversity original dataset, uterine samples, with P-values

```{r}
my_comparisons_alpha_location <- list( c("Left Tip", "Left Base"), c("Right Base", "Left Base"), c("Right Base", "Left Tip"), c("Right Tip", "Left Base"), c("Right Tip", "Left Tip"), c("Right Tip", "Right Base") )

plot_alpha_uterus_P <- plot_richness(physequterus, x="Location", measures=c("Shannon", "InvSimpson"), color="Location") +
  theme_bw() +
  scale_color_manual(values= c("#952EA0","#DF488D", "#F89078", "#e8fa5bff"))+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20),
        title=element_text(size=14), legend.text=element_text(size=14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 12)) + 
  stat_compare_means(comparisons = my_comparisons_alpha_location)+
  stat_compare_means()

print(plot_alpha_uterus_P)
```

## Beta diversity

### Original dataset - uterine samples

```{r}
# Rescale OTU table to account for library size differences

scale_reads <- function(physequterus, n = min(sample_sums(physequterus)), round = "floor") {
  # transform counts to n
  physeq.scale_uterus <- transform_sample_counts(physequterus, 
                                          function(x) {(n * x/sum(x))}
                                          )
  # Pick the rounding functions
  if (round == "floor"){
    otu_table(physeq.scale_uterus) <- floor(otu_table(physeq.scale_uterus))
    } else if (round == "round"){
      otu_table(physeq.scale_uterus) <- myround(otu_table(physeq.scale_uterus))
      }
  
  # Prune taxa and return new phyloseq object
  physeq.scale_uterus <- prune_taxa(taxa_sums(physeq.scale_uterus) > 0, physeq.scale_uterus)
  return(physeq.scale_uterus)
  }

df_phy_scaled_uterus <- scale_reads(physequterus)

# Start making the PCoA
pcoa <- ordinate(
  physeq = df_phy_scaled_uterus, 
  method = "PCoA", 
  distance = "bray",
  correction = "lingoes",
  k=2
)

# Transform  to dataframe
pcoa.df <- data.frame(pcoa$vectors, sample_data(df_phy_scaled_uterus))

# Calculate the variance explained
var <- round(pcoa$values$Eigenvalues/sum(pcoa$values$Eigenvalues)*100,1)

# Exploratory permanova to see suggested effect sizes -> Similar variances across treatments
dist.seq <- vegan::vegdist(t(otu_table(df_phy_scaled_uterus)))
disper.seq <- vegan::betadisper(dist.seq, group = sample_data(df_phy_scaled_uterus)$Location)
anova(disper.seq)
print(disper.seq)

# Calculate distance and save as a matrix
BC.dist=vegdist(OTUdf_uterus, distance="bray")
# Run PERMANOVA on distances
adonis(BC.dist ~ metadata_uterus$Location, data = OTUdf_uterus, permutations = 1000)

# Test homogeneity
disp.location = betadisper(BC.dist, metadata_uterus$Location)
permutest(disp.location, pairwise=TRUE, permutations=1000)
```

#### Visualisation

Plot beta diversity original dataset, uterine samples

```{r}
plot_beta_uterus <- ggplot(data = pcoa.df, aes(x=Axis.1, 
                                              y=Axis.2, color=Location))+
  geom_point(alpha=0.7, size=7)+
  theme_bw()+
  scale_color_manual(values= c("#952EA0","#DF488D", "#F89078", "#e8fa5bff"))+
  labs(x = paste0("PCoA axis 1 (",var[1], "%)"), 
       y = paste0("PCoA axis 2 (",var[2], "%)"), 
       colour="")+  
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14),
        title=element_text(size=20), legend.text=element_text(size=16))+
  guides(fill = guide_legend(override.aes = list(shape = 22)))

print(plot_beta_uterus)
```

### Original dataset - uterine samples versus vaginal samples

```{r}
metadata_utvag <- metadata[c(1:5, 9:13, 15:19, 22:31),]

vaguterus_df <- otu_df %>% dplyr::select(RT1,RT2,RT3,RT4,RT5,RB1,RB2,RB3,RB4,RB5,LT1,LT2,LT3,LT4,LT5,LB1,LB2,LB3,LB4,LB5,VAG1,VAG2,VAG3,VAG4,VAG5)

# Calculate distance and save as a matrix
BC.dist=vegdist(t(vaguterus_df), distance="bray")
# Run PERMANOVA on distances.
adonis(BC.dist ~ metadata_utvag$UT_or_VAG, data = vaguterus_df, permutations = 1000)

# Test homogeneity
disp.location = betadisper(BC.dist, metadata_utvag$UT_or_VAG)
permutest(disp.location, pairwise=TRUE, permutations=1000)
```

# Microbial community analysis: Simper

Similarity percentages to extract most influential bacteria (OTU level vs. family level)

## Original dataset - uterine samples

### OTU level

```{r}
simper(OTUdf_uterus, metadata_uterus$Location, permutations=100)
```

Test every single OTU indicated by the Simper function --> are these OTUs significantly influential bacteria ?

Example for OTU0001: 

```{r}
kruskal.test(OTUdf_uterus$Otu0001 ~ metadata_uterus$Location)
```

### Family level 

```{r}
# Extract abundance matrix from the phyloseq object
otu_uterus_family = as(otu_table(physequterus_family_scale), "matrix")
# transpose if necessary
if(taxa_are_rows(physequterus_family_scale)){otu_uterus_family <- t(otu_uterus_family)}
# Coerce to data.frame
OTUdf_uterus_family = as.data.frame(otu_uterus_family)

simper(OTUdf_uterus_family, metadata_uterus$Location, permutations=100)
```

Test every single OTU indicated by the Simper function --> are these OTUs significantly influential bacteria ?

Example for OTU0036: 

```{r}
kruskal.test(OTUdf_uterus_family$Otu0036 ~ metadata_uterus$Location)
```

# DECONTAMINATION 

# Microbial community analyses: Decontamination

Prevalence based filtering of putative contaminant OTUs

PART 1: decontaminate uterine samples, vaginal samples and sampling controls based on reads in the blank controls (= technical contamination)

## Create decontaminated dataset - OTU level - all samples, negative controls and DNA extraction blank controls 

```{r}
# Define sample as blank control = "False sample"
sample_data(physeq)$is.neg <- sample_data(physeq)$Sample_or_Control == "False Sample"
```

### Define putative contaminant OTUs using the IsContaminant function of the decontam package (prevalence-based)

```{r}
contamdf.prev05_1 <- isContaminant(physeq, method="prevalence", neg="is.neg", threshold=0.5)
table(contamdf.prev05_1$contaminant)
```

```{r}
which(contamdf.prev05_1$contaminant)
```

```{r}
# Make phyloseq objects of presence-absence of every OTU in DNA extraction blank controls versus in biological samples
ps.pa <- transform_sample_counts(physeq, function(abund) 1*(abund>0))
ps.pa.neg <- prune_samples(sample_data(ps.pa)$Sample_or_Control == "False Sample", ps.pa)
ps.pa.pos <- prune_samples(sample_data(ps.pa)$Sample_or_Control  != "False Sample", ps.pa)
# Make data.frame of prevalence in DNA extraction blank controls versus in biological samples
df.pa <- data.frame(pa.pos=taxa_sums(ps.pa.pos), pa.neg=taxa_sums(ps.pa.neg),
                      contaminant=contamdf.prev05_1$contaminant)

# Visualisation 
ggplot(data=df.pa, aes(x=pa.neg, y=pa.pos, color = contaminant, shape = contaminant)) +
  geom_jitter() +
  scale_shape_manual(values=c(22,21)) +
  xlab("Prevalence in DNA extraction blank controls") + 
  ylab("Prevalence in biological samples \n and sampling controls") +
  scale_color_manual(values= c("black", "gray50"), name = "", labels = c("No contaminant", "Contaminant")) +
  theme(panel.background = element_rect(fill = "white", linetype = "solid", colour = "white"), legend.position="bottom") +
  guides(shape = FALSE)
```

### Define putative non-contaminant OTUs using the IsNotContaminant function of the decontam package (prevalence-based)

```{r}
nocontamdf.prev05_1 <- isNotContaminant(physeq, method="prevalence", neg="is.neg", threshold = 0.5)
table(nocontamdf.prev05_1)
```

```{r}
which(nocontamdf.prev05_1)
```

```{r}
# Make phyloseq objects of presence-absence of every OTU in DNA extraction blank controls versus in biological samples
ps.pa <- transform_sample_counts(physeq, function(abund) 1*(abund>0))
ps.pa.neg <- prune_samples(sample_data(ps.pa)$Sample_or_Control == "False Sample", ps.pa)
ps.pa.pos <- prune_samples(sample_data(ps.pa)$Sample_or_Control != "False Sample", ps.pa)
# Make data.frame of prevalence in DNA extraction blank controls versus in biological samples
df.pa <- data.frame(pa.pos=taxa_sums(ps.pa.pos), pa.neg=taxa_sums(ps.pa.neg),
                      contaminant=!nocontamdf.prev05_1)

# Visualisation
ggplot(data=df.pa, aes(x=pa.neg, y=pa.pos, color = contaminant, shape = contaminant)) +
  geom_jitter() +
  scale_shape_manual(values=c(22,21)) +
  xlab("Prevalence in DNA extraction blank controls") + 
  ylab("Prevalence in biological samples \n and sampling controls") +
  scale_color_manual(values= c("black", "gray50"), name = "", labels = c("No contaminant", "Contaminant")) +
  theme(panel.background = element_rect(fill = "white", linetype = "solid", colour = "white"), legend.position="bottom") +
  guides(shape = FALSE)
```

# Microbial community analyses: taxonomic identification

## Create phyloseq object "physeq_decontam" from csv file - decontaminated dataset - all samples and DNA extraction blank controls - only putative non-contaminant OTUs (IsNotContaminant function) remained

```{r}
# Create decontaminated otu-table
nocontam_otu_1 <- otu_data[which(nocontamdf.prev05_1),]

# Taxonomy table
tax_df_decontam_1 <- nocontam_otu_1 %>% dplyr::select(OTU:genus)
rownames(tax_df_decontam_1) <- tax_df_decontam_1$OTU

# Create OTU table with all samples
otu_df_decontam_1 <- nocontam_otu_1 %>% dplyr::select(RT1:VAG5)

# Name the rows with the names of the OTUs
rownames(otu_df_decontam_1) <- tax_df_decontam_1$OTU

tax_df_decontam_1 <- tax_df_decontam_1 %>% dplyr::select(-c(OTU,Size))

physeq_decontam_1 <- phyloseq(otu_table(otu_df_decontam_1, taxa_are_rows = TRUE),
                   tax_table(as.matrix(tax_df_decontam_1)))
physeq_decontam_1

colnames(tax_table(physeq_decontam_1)) <- c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus")
rownames(metadata) <- metadata$Sample # make sure rownames are matching with physeq
sample_data(physeq_decontam_1) <- sample_data(metadata) # add metadata

summarize_phyloseq(physeq_decontam_1)
```

```{r}
# Check library sizes
hist(sample_sums(physeq_decontam_1), breaks = 100)
print(sample_sums(physeq_decontam_1))
```

```{r}
### number of OTUs per sample
numberotu_df_decontam_1 <- otu_table(physeq_decontam_1)
colSums(numberotu_df_decontam_1 != 0)
```

### Visualisation

```{r}
###Select 25 top otus based on relative abunance
#Relative abundance
relabsphyseq_decontam_1 <- transform_sample_counts(physeq_decontam_1 , function(x) x/sum(x))
# Select 25 top otus based on relative abunance
TopNOTUs.relab_decontam_1 <- names(sort(taxa_sums(relabsphyseq_decontam_1), TRUE)[1:25])
physeqobj25.relab_decontam_1  <- prune_taxa(TopNOTUs.relab_decontam_1, relabsphyseq_decontam_1)

#family level barplot
phyplot.rel.family_decontam_1 <- plot_bar(physeqobj25.relab_decontam_1, x ="Sample", fill="Family")
phyplot.rel.family_decontam_1 + 
  facet_grid(~ Location, scales="free_x", space = "free_x") +
  ylab("Relative Abundance")+ xlab("")+
  scale_fill_manual(values= c("#FFFF00", "#FFEC00", "#FFD308", "#EDFB3C", "#BAD303", "#4F820D", "#385C0A", "#0F8482", "#418CFC", "#92D8FE", "#334C89", "#61307D", "#AD208E", "#FC43D3", "#F8642C", "#D63118", "#9F2A00", "#7C5547"))+
  theme_bw()+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20),
        title=element_text(size=20), legend.text=element_text(size=16),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 12))
```

# Microbial community analyses: Decontamination

Prevalence based filtering of putative contaminant OTUs

PART 2: second decontamination: decontaminate again non-contaminant reads in the uterine samples based on non-contaminant reads in the sampling controls (= contamination during sampling)

exclude blank and vaginal samples from dataset

```{r}
# Taxonomy table
tax_df <- nocontam_otu_1 %>% dplyr::select(OTU:genus)
rownames(tax_df) <- tax_df$OTU

# Create OTU table with all samples
otu_df_decontam_1 <- nocontam_otu_1 %>% dplyr::select(RT1:VAG5)

# Remove the sampling control samples
otu_excl_df <- otu_df_decontam_1 %>% dplyr::select(-c(VAG1, VAG2, VAG3, VAG4, VAG5, BLANK1, BLANK2, BLANK3))

# Name the rows with the names of the OTUs
rownames(otu_excl_df) <- tax_df$OTU

tax_df <- tax_df %>% dplyr::select(-c(OTU,Size))

physeq_decontam_1_excl <- phyloseq(otu_table(otu_excl_df, taxa_are_rows = TRUE),
                   tax_table(as.matrix(tax_df)))
physeq_decontam_1_excl

colnames(tax_table(physeq_decontam_1_excl)) <- c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus")
rownames(metadata) <- metadata$Sample # make sure rownames are matching with physeq
sample_data(physeq_decontam_1_excl) <- sample_data(metadata) # add metadata

summarize_phyloseq(physeq_decontam_1_excl)
```

## Create decontaminated dataset - OTU level - all samples, negative controls and DNA extraction blank controls 

```{r}
# Define sample as blank control = "False sample"
sample_data(physeq_decontam_1_excl)$is.neg <- sample_data(physeq_decontam_1_excl)$Sample_or_Control == "Neg Sample"
```

### Define putative contaminant OTUs using the IsContaminant function of the decontam package (prevalence-based)

```{r}
contamdf.prev05 <- isContaminant(physeq_decontam_1_excl, method="prevalence", neg="is.neg", threshold=0.5)
table(contamdf.prev05$contaminant)
```

```{r}
which(contamdf.prev05$contaminant)
```

```{r}
# Make phyloseq objects of presence-absence of every OTU in sampling controls versus in biological samples
ps.pa <- transform_sample_counts(physeq_decontam_1_excl, function(abund) 1*(abund>0))
ps.pa.neg <- prune_samples(sample_data(ps.pa)$Sample_or_Control == "Neg Sample", ps.pa)
ps.pa.pos <- prune_samples(sample_data(ps.pa)$Sample_or_Control  == "True Sample", ps.pa)
# Make data.frame of prevalence in DNA extraction blank controls versus in biological samples
df.pa <- data.frame(pa.pos=taxa_sums(ps.pa.pos), pa.neg=taxa_sums(ps.pa.neg),
                      contaminant=contamdf.prev05$contaminant)

# Visualisation 
ggplot(data=df.pa, aes(x=pa.neg, y=pa.pos, color = contaminant, shape = contaminant)) +
  geom_jitter() +
  scale_shape_manual(values=c(22,21)) +
  xlab("Prevalence in sampling controls") + 
  ylab("Prevalence in uterine samples") +
  scale_color_manual(values= c("black", "gray50"), name = "", labels = c("No contaminant", "Contaminant")) +
  theme(panel.background = element_rect(fill = "white", linetype = "solid", colour = "white"), legend.position="bottom") +
  guides(shape = FALSE)
```

### Define putative non-contaminant OTUs using the IsNotContaminant function of the decontam package (prevalence-based)

```{r}
nocontamdf.prev05 <- isNotContaminant(physeq_decontam_1_excl, method="prevalence", neg="is.neg", threshold = 0.5)
table(nocontamdf.prev05)
```

```{r}
which(nocontamdf.prev05)
```

```{r}
# Make phyloseq objects of presence-absence of every OTU in DNA extraction blank controls versus in biological samples
ps.pa <- transform_sample_counts(physeq_decontam_1_excl, function(abund) 1*(abund>0))
ps.pa.neg <- prune_samples(sample_data(ps.pa)$Sample_or_Control == "Neg Sample", ps.pa)
ps.pa.pos <- prune_samples(sample_data(ps.pa)$Sample_or_Control == "True Sample", ps.pa)
# Make data.frame of prevalence in DNA extraction blank controls versus in biological samples
df.pa <- data.frame(pa.pos=taxa_sums(ps.pa.pos), pa.neg=taxa_sums(ps.pa.neg),
                      contaminant=!nocontamdf.prev05)

# Visualisation
ggplot(data=df.pa, aes(x=pa.neg, y=pa.pos, color = contaminant, shape = contaminant)) +
  geom_jitter() +
  scale_shape_manual(values=c(22,21)) +
  xlab("Prevalence in sampling controls") + 
  ylab("Prevalence in uterine samples") +
  scale_color_manual(values= c("black", "gray50"), name = "", labels = c("No contaminant", "Contaminant")) +
  theme(panel.background = element_rect(fill = "white", linetype = "solid", colour = "white"), legend.position="bottom") +
  guides(shape = FALSE)
```

# Microbial community analyses: taxonomic identification

## Create phyloseq object "physeq_decontam" from csv file - decontaminated dataset - all samples and DNA extraction blank controls - only putative non-contaminant OTUs (IsNotContaminant function) remained

```{r}
# Create decontaminated otu-table
nocontam_otu <- nocontam_otu_1[which(nocontamdf.prev05),]

# Taxonomy table
tax_df_decontam <- nocontam_otu %>% dplyr::select(OTU:genus)
rownames(tax_df_decontam) <- tax_df_decontam$OTU

# Create OTU table with all samples
otu_df_decontam <- nocontam_otu %>% dplyr::select(RT1:VAG5)

# Remove the sampling control samples
otu_df_decontam <- otu_df_decontam %>% dplyr::select(-c(VAG1, VAG2, VAG3, VAG4, VAG5, BLANK1, BLANK2, BLANK3))

# Name the rows with the names of the OTUs
rownames(otu_df_decontam) <- tax_df_decontam$OTU

tax_df_decontam <- tax_df_decontam %>% dplyr::select(-c(OTU,Size))

physeq_decontam <- phyloseq(otu_table(otu_df_decontam, taxa_are_rows = TRUE),
                   tax_table(as.matrix(tax_df_decontam)))
physeq_decontam

colnames(tax_table(physeq_decontam)) <- c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus")
rownames(metadata) <- metadata$Sample # make sure rownames are matching with physeq
sample_data(physeq_decontam) <- sample_data(metadata) # add metadata

summarize_phyloseq(physeq_decontam)
```

```{r}
# Check library sizes
hist(sample_sums(physeq_decontam), breaks = 100)
print(sample_sums(physeq_decontam))
```

```{r}
### number of OTUs per sample
numberotu_df_decontam <- otu_table(physeq_decontam)
colSums(numberotu_df_decontam != 0)
```

### Visualisation

```{r}
###Select 25 top otus based on relative abunance
#Relative abundance
relabsphyseq_decontam <- transform_sample_counts(physeq_decontam , function(x) x/sum(x))
# Select 25 top otus based on relative abunance
TopNOTUs.relab_decontam <- names(sort(taxa_sums(relabsphyseq_decontam), TRUE)[1:25])
physeqobj25.relab_decontam  <- prune_taxa(TopNOTUs.relab_decontam, relabsphyseq_decontam)

#family level barplot
phyplot.rel.family_decontam <- plot_bar(physeqobj25.relab_decontam, x ="Sample", fill="Family")
phyplot.rel.family_decontam + 
  facet_grid(~ Location, scales="free_x", space = "free_x") +
  ylab("Relative Abundance")+ xlab("")+
  scale_fill_manual(values= c("#FFFF00", "#FFEC00", "#FFD308", "#EDFB3C", "#BAD303", "#4F820D", "#385C0A", "#0F8482", "#418CFC", "#92D8FE", "#334C89", "#61307D", "#AD208E", "#FC43D3", "#F8642C", "#D63118", "#9F2A00", "#7C5547"))+
  theme_bw()+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20),
        title=element_text(size=20), legend.text=element_text(size=16),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 12))
```

# Microbial community analysis: Compose decontaminated dataset: double decontamination of uterine samples and decontamination of vaginal samples

```{r}
all_decontam_otu <- merge(nocontam_otu_1, nocontam_otu, by.x="OTU", by.y = "OTU", all = TRUE)

all_decontam_otu$VAG1 <- all_decontam_otu$VAG1.x
all_decontam_otu$VAG2 <- all_decontam_otu$VAG2.x
all_decontam_otu$VAG3 <- all_decontam_otu$VAG3.x
all_decontam_otu$VAG4 <- all_decontam_otu$VAG4.x
all_decontam_otu$VAG5 <- all_decontam_otu$VAG5.x

all_decontam_otu$RT1 <- all_decontam_otu$RT1.y
all_decontam_otu$RT2 <- all_decontam_otu$RT2.y
all_decontam_otu$RT3 <- all_decontam_otu$RT3.y
all_decontam_otu$RT4 <- all_decontam_otu$RT4.y
all_decontam_otu$RT5 <- all_decontam_otu$RT5.y
all_decontam_otu$RB1 <- all_decontam_otu$RB1.y
all_decontam_otu$RB2 <- all_decontam_otu$RB2.y
all_decontam_otu$RB3 <- all_decontam_otu$RB3.y
all_decontam_otu$RB4 <- all_decontam_otu$RB4.y
all_decontam_otu$RB5 <- all_decontam_otu$RB5.y
all_decontam_otu$LT1 <- all_decontam_otu$LT1.y
all_decontam_otu$LT2 <- all_decontam_otu$LT2.y
all_decontam_otu$LT3 <- all_decontam_otu$LT3.y
all_decontam_otu$LT4 <- all_decontam_otu$LT4.y
all_decontam_otu$LT5 <- all_decontam_otu$LT5.y
all_decontam_otu$LB1 <- all_decontam_otu$LB1.y
all_decontam_otu$LB2 <- all_decontam_otu$LB2.y
all_decontam_otu$LB3 <- all_decontam_otu$LB3.y
all_decontam_otu$LB4 <- all_decontam_otu$LB4.y
all_decontam_otu$LB5 <- all_decontam_otu$LB5.y

all_decontam_otu <- select(all_decontam_otu, OTU, regnum.x:genus.x, VAG1:LB5)

all_decontam_otu[is.na(all_decontam_otu)] <- 0
```


## Decontaminated dataset - OTU level - uterine and vaginal samples, sampling controls - only putative non-contaminant OTUs (IsNotContaminant function) remained

Exclude sampling controls (for graphs)

```{r}
# Taxonomy table
tax_df_decontam <- all_decontam_otu %>% dplyr::select(OTU:genus.x)
rownames(tax_df_decontam) <- tax_df_decontam$OTU

# Create OTU table with all samples
otu_df_all_decontam <- all_decontam_otu %>% dplyr::select(VAG1:LB5)

# Name the rows with the names of the OTUs
rownames(otu_df_all_decontam) <- tax_df_decontam$OTU

tax_df_decontam <- tax_df_decontam %>% dplyr::select(-c(OTU))

physeq_decontam_repro <- phyloseq(otu_table(otu_df_all_decontam, taxa_are_rows = TRUE),
                   tax_table(as.matrix(tax_df_decontam)))
physeq_decontam_repro

colnames(tax_table(physeq_decontam_repro)) <- c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus")
rownames(metadata) <- metadata$Sample # make sure rownames are matching with physeq
sample_data(physeq_decontam_repro) <- sample_data(metadata) # add metadata

summarize_phyloseq(physeq_decontam_repro)
```

### Visualisation

only samples (uterine and vaginal) - decontaminated dataset - family level (HEX colors)

```{r}
# Relative abundance
relabphyseq_decontam <- transform_sample_counts(physeq_decontam_repro, function(x) x/sum(x))
# Select 25 top OTUs based on relative abunance
TopNOTUs.relab.decontam <- names(sort(taxa_sums(relabphyseq_decontam), TRUE)[1:25])
physeqobj25.relab_decontam  <- prune_taxa(TopNOTUs.relab.decontam, relabphyseq_decontam)

# Generate a barplot - family level
phyplot.rel.decontam <- plot_bar(physeqobj25.relab_decontam, x ="Sample", fill="Family")
phyplot.rel.decontam + 
  facet_grid(~ Location, scales="free_x", space = "free_x") +
  ylab("Relative Abundance")+ xlab("")+
  scale_fill_manual(values= c("#FFEC00", "#FFD308", "#BAD303", "#4F820D", "#385C0A", "#166D66", "#0F8482", "#72DCD8", "#0AFBFB", "#418CFC", "#92D8FE", "#326BB7", "#61307D", "#AD208E", "#FF80D3", "#FC43D3", "#D63118", "red","blue"))+
  theme_bw()+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20),
        title=element_text(size=20), legend.text=element_text(size=16),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 12))
```

only samples (uterine and vaginal) - decontaminated dataset - family level - Heatmap

```{r}
GPr  = transform_sample_counts(physeq_decontam_repro, function(x) x / sum(x) )
gpt <- prune_taxa(names(sort(taxa_sums(GPr),TRUE)[1:25]),GPr)
HM <- plot_heatmap(gpt, method = "NMDS", distance = "bray", taxa.label = 'Family', trans="log10")
HM <- HM + 
  theme_bw()+
  # scale_fill_continuous(name="Relative abundance")+
  theme(axis.text.x = element_text(size=7, angle = 45, hjust = 1))+
  facet_grid(~ Location, scales="free_x", space = "free_x")
plot(HM)
```

## Decontaminated dataset - phylum level - uterine and vaginal samples

### Create Phyloseq object "physeq_phylum_scale_decontam_repro" - decontaminated dataset - pooled by phylum level - all samples

```{r}
# Pool at phylum level
physeq_phylum_scale_decontam_repro = tax_glom(physeq_decontam_repro, "Phylum")

# Calculate relative abundances
relabphyseq_phylum_scale_decontam_repro <- transform_sample_counts(physeq_phylum_scale_decontam_repro, function(x) 100*x/sum(x))

# Select top 5 phyla
TopNPhyla.relabphyseq_phylum_scale_decontam_repro <- names(sort(taxa_sums(relabphyseq_phylum_scale_decontam_repro), TRUE)[1:5])

tax_table(relabphyseq_phylum_scale_decontam_repro)[!taxa_names(relabphyseq_phylum_scale_decontam_repro) %in% TopNPhyla.relabphyseq_phylum_scale_decontam_repro, "Phylum"] <- "Other"

# psmelt into dataframe
df_relabphyseq_phylum_scale_decontam_repro_pruned <- psmelt(relabphyseq_phylum_scale_decontam_repro)

sum_table_phyla <- df_relabphyseq_phylum_scale_decontam_repro_pruned %>% group_by(Phylum) %>% summarize(sum_abund = sum(Abundance))

names_sorted_phyla <- as.character(sum_table_phyla$Phylum)[order(sum_table_phyla$sum_abund,
                                                                  decreasing = TRUE)]

# sort phyla in order of abundance, put "other" last
names_sorted_phyla <- c(names_sorted_phyla[names_sorted_phyla != "Other"],
                         names_sorted_phyla[names_sorted_phyla == "Other"])

df_relabphyseq_phylum_scale_decontam_repro_pruned$Phylum <- factor(as.character(df_relabphyseq_phylum_scale_decontam_repro_pruned$Phylum),
                                       levels = names_sorted_phyla)

# Finally we merge the phyla present in "Others"
df_relabphyseq_phylum_scale_decontam_repro_pruned_remerged <- df_relabphyseq_phylum_scale_decontam_repro_pruned %>% 
  group_by(Phylum, Sample) %>% summarize(sum_abund = sum(Abundance))

# Add metadata AGAIN
df_relabphyseq_phylum_scale_decontam_repro_pruned_remerged <- left_join(df_relabphyseq_phylum_scale_decontam_repro_pruned_remerged,
                                             metadata[-6], 
                                                by = c("Sample" = "Sample")
                                             ) %>% distinct()
```

### Visualisation

only samples -decontaminated dataset - pooled by phylum level

```{r}
# Generate a plot with the relative abundances pooled by phylum - facet by Location
phyplot.decontam.phylum_repro <- ggplot(aes(Sample, y = sum_abund, 
                        fill = Phylum, color = Phylum), data = df_relabphyseq_phylum_scale_decontam_repro_pruned_remerged)+
  geom_bar(stat="identity", alpha = 1)+
  scale_color_manual(values = rep("black", 26))+
  facet_grid(~ Location, scales="free_x", space = "free_x") +
  ylab("Relative Abundance (%)")+ xlab("")+
  scale_fill_manual(values= c("#D40C00", "#FF9A00", "#87C735", "#EDFB3C", "#526EFF", "#4B0082"))+
  theme_bw()+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20),
        title=element_text(size=20), legend.text=element_text(size=16),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 12))

print(phyplot.decontam.phylum_repro)
```

## Decontaminated dataset - family level - uterine and vaginal samples

### Create Phyloseq object "physeq_family_scale_decontam_repro" - decontaminated dataset - pooled by family level - all samples

```{r}
# Pool at family level
physeq_family_scale_decontam_repro = tax_glom(physeq_decontam_repro, "Family")

# Calculate relative abundances
relabphyseq_family_scale_decontam_repro <- transform_sample_counts(physeq_family_scale_decontam_repro, function(x) 100*x/sum(x))

# Select top 5 families
TopNFamilies.relabphyseq_family_scale_decontam_repro <- names(sort(taxa_sums(relabphyseq_family_scale_decontam_repro), TRUE)[1:5])

tax_table(relabphyseq_family_scale_decontam_repro)[!taxa_names(relabphyseq_family_scale_decontam_repro) %in% TopNFamilies.relabphyseq_family_scale_decontam_repro, "Family"] <- "Other"

# psmelt into dataframe
df_relabphyseq_family_scale_decontam_repro_pruned <- psmelt(relabphyseq_family_scale_decontam_repro)

sum_table_families <- df_relabphyseq_family_scale_decontam_repro_pruned %>% group_by(Family) %>% summarize(sum_abund = sum(Abundance))

names_sorted_families <- as.character(sum_table_families$Family)[order(sum_table_families$sum_abund,
                                                                  decreasing = TRUE)]

# sort families in order of abundance, put "other" last
names_sorted_families <- c(names_sorted_families[names_sorted_families != "Other"],
                         names_sorted_families[names_sorted_families == "Other"])

df_relabphyseq_family_scale_decontam_repro_pruned$Family <- factor(as.character(df_relabphyseq_family_scale_decontam_repro_pruned$Family),
                                       levels = names_sorted_families)

# Finally we merge the families present in "Others"
df_relabphyseq_family_scale_decontam_repro_pruned_remerged <- df_relabphyseq_family_scale_decontam_repro_pruned %>% 
  group_by(Family, Sample) %>% summarize(sum_abund = sum(Abundance))

# Add metadata AGAIN
df_relabphyseq_family_scale_decontam_repro_pruned_remerged <- left_join(df_relabphyseq_family_scale_decontam_repro_pruned_remerged,
                                             metadata[-6], 
                                                by = c("Sample" = "Sample")
                                             ) %>% distinct()
```

### Visualisation

only samples -decontaminated dataset - pooled by family level

```{r}
# Generate a plot with the relative abundances pooled by family - facet by Location
phyplot.decontam.family_repro <- ggplot(aes(Sample, y = sum_abund, 
                        fill = Family, color = Family), data = df_relabphyseq_family_scale_decontam_repro_pruned_remerged)+
  geom_bar(stat="identity", alpha = 1)+
  scale_color_manual(values = rep("black", 26))+
  facet_grid(~ Location, scales="free_x", space = "free_x") +
  ylab("Relative Abundance (%)")+ xlab("")+
  scale_fill_manual(values= c("#D40C00", "#FF9A00", "#EDFB3C", "#87C735", "#526EFF", "#4B0082"))+
  theme_bw()+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20),
        title=element_text(size=20), legend.text=element_text(size=16),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 12))

print(phyplot.decontam.family_repro)
```

## Decontaminated dataset - OTU level - only uterine samples

### Create Phyloseq object "physeq_decontamuterus" - decontaminated dataset - only uterine samples

```{r}
# metadata
metadata_uterus <- metadata[c(1:4, 9:12, 15:18, 22:25, 27:30),]

# Create phyloseq object from csv file
# Taxonomy table
tax_df_decontamuterus <- nocontam_otu %>% dplyr::select(OTU:genus)
rownames(tax_df_decontamuterus) <- tax_df_decontamuterus$OTU

# Create OTU table with only uterine samples
otu_df_decontamuterus <- nocontam_otu %>% dplyr::select(RT1:VAG5)
uterus_decontam_df <- otu_df_decontamuterus %>% dplyr::select(RT1,RT2,RT3,RT4,RT5,RB1,RB2,RB3,RB4,RB5,LT1,LT2,LT3,LT4,LT5,LB1,LB2,LB3,LB4,LB5)

# Name the rows with the names of the OTUs
rownames(uterus_decontam_df) <- tax_df_decontamuterus$OTU

tax_df_decontamuterus <- tax_df_decontamuterus %>% dplyr::select(-c(OTU,Size))

physeq_decontamuterus <- phyloseq(otu_table(uterus_decontam_df, taxa_are_rows = TRUE),
                   tax_table(as.matrix(tax_df_decontamuterus)))

colnames(tax_table(physeq_decontamuterus)) <- c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus")
rownames(metadata) <- metadata$Sample # make sure rownames are matching with physeq
sample_data(physeq_decontamuterus) <- sample_data(metadata) # add metadata

summarize_phyloseq(physeq_decontamuterus)

# otu table as matrix / data.frame
# Extract abundance matrix from the phyloseq object
otu_uterus_decontam = as(otu_table(physeq_decontamuterus), "matrix")
# transpose if necessary
if(taxa_are_rows(physeq_decontamuterus)){otu_uterus_decontam <- t(otu_uterus_decontam)}
# Coerce to data.frame
OTUdf_uterus_decontam = as.data.frame(otu_uterus_decontam)
```

### Visualisation

only uterine samples - decontaminated dataset - genus level

```{r}
#Relative abundance
relabphyseq_decontamuterus <- transform_sample_counts(physeq_decontamuterus , function(x) x/sum(x))

### Select 25 top otus based on relative abundance
TopNOTUs.relab_decontamuterus <- names(sort(taxa_sums(relabphyseq_decontamuterus), TRUE)[1:25])
physeqobj25.relab_decontamuterus <- prune_taxa(TopNOTUs.relab_decontamuterus, relabphyseq_decontamuterus)

# Generate a barplot - genus level
phyplot.decontamuterus_genus <- plot_bar(physeqobj25.relab_decontamuterus, x ="Sample", fill="Genus")
phyplot.decontamuterus_genus + 
  facet_grid(~ Location, scales="free_x", space = "free_x") +
  ylab("Relative Abundance (%)")+ xlab("")+
  scale_fill_viridis(discrete=TRUE, option="plasma")+
  theme_bw()+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20),
        title=element_text(size=20), legend.text=element_text(size=16),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 12))

# Generate a barplot - family level 
phyplot.decontamuterus_family <- plot_bar(physeqobj25.relab_decontamuterus, x ="Sample", fill="Family")
phyplot.decontamuterus_family + 
  facet_grid(~ Location, scales="free_x", space = "free_x") +
  ylab("Relative Abundance (%)")+ xlab("")+
  scale_fill_manual(values= c("#FFFFFF", "#FFEC00", "#FFD308", "#B5FF66", "#66FFCC", "#4F820D","#999999", "#0D2282", "#0D8282",  "#72DCD8", "#0AFBFB", "#418CFC", "#6932B7", "#326BB7", "#FF80D3", "#FC43D3", "#F8642C", "#B36D47"))+
  theme_bw()+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20),
        title=element_text(size=20), legend.text=element_text(size=16),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 12))
```
